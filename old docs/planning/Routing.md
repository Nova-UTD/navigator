# Routing

We use the term *route* to describe a sequence of lanes that connect two points, typically the current location and some destination. *Routes* should not be confused with *paths*, which describe the detailed physical trajectory that the vehicle should follow in order to progress along a route. A path can be thought of as a sequence of (x,y) points, while a route is a sequence of lanes.

Routing is done like so:

1. Identify the lane occupied by the start point and the lane occupied by the end point.
2. Construct a routing graph of the map. This is a data structure that describes how lanes connect to each other. If one is already generated for the current map, use it.
3. Starting at either the destination or the source lane, perform breadth-first search (BFS) on the routing graph until the lane at the other end is reached. This provides an *unordered map* of connectivity pairs, where each pair is two lanes that connect to each other. A proper route should be *directed* such that the second element in the pair is a lane that "flows" into the next lane. This avoids routes that go against traffic flow.
4. Select the last pair, the one that includes either the start or destination lane as its first element. Search for its second element in the map to work your way up to the other end. Each time, append the elements to an ordered list.

This ordered list is the (directed) route.

## Which way is forward?

The following assumes that we're driving in a right-hand country (the US).

OpenDRIVE does not offer a convenient way to check for a lane's driving direction. Lanes have "successors" and "predecessors," but maps generated by RoadRunner cannot be trusted to follow this pattern. In other words, a lane's "successor" could actually be its previous lane in terms of driving direction, and vice versa.

The only way to check that a given lane is the true successor of another connected lane (again with respect to driving direction) is to refer to both of their coordinate systems. **A right-side lane** will either:

- Have a positive ID and have a decreasing s value from start to end OR
- Have a negative ID and an increasing s value from start to end.

![image-20230409194330319](/home/wheitman/.config/Typora/typora-user-images/image-20230409194330319.png)

Here is how to find a given lane's successor(s):

- Find the s value at its end.
  - If the lane's ID is positive, $s=0$
  - If negative, $s=s_{max}$, a value that libOpenDRIVE can provide.
- Get the (x,y) coordinate of the centerline (or border) at this s value.
- Combine all of the lane's listed "predecessors" and "successors" into a single array.
- For each lane in the array, get the (x,y) coordinate of its centerline (or border) at $s=0$. Calculate the distance from this (x,y) point to the earlier point. If the distance is near-zero



For a lane:

- Find its end. If lane ID < 0, end is at $s= s_{max}$, else at $s=0$.

- Get end's (x,y) coord.

- For all listed predecessors and successors, find their starts:

  - If ID < 0, start is at $s=0$, else at $s=s_{max}$
  - Get endpoint's (x,y) coord.
  - Find distance between (x,y) coords. Should be near-zero if they are connected.

  